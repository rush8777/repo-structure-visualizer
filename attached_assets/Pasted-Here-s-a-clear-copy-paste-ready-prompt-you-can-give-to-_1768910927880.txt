Here‚Äôs a **clear, copy-paste ready prompt** you can give to **Replit AI**.
It is written so the agent **does not guess**, **does not refactor unrelated code**, and **fixes only the real bug**.

---

### ‚úÖ **Replit Prompt: Fix React Flow Group Expand Position Bug**

> **Context**
>
> I am using **React Flow** with **group/parent nodes** and **selection grouping** (`parentNode`, `extent: "parent"`).
>
> There is a bug where:
>
> * After moving a **parent (group) node**
> * Collapsing it (hiding children)
> * Then expanding it again
>
> All **child nodes reappear from the center/origin of the parent**, instead of their original positions.
>
> This happens because child node positions are being **recomputed or reset** on expand, instead of preserved as **relative-to-parent coordinates**.

---

### üîç **Your Task**

Fix this bug by **preserving child node relative positions** correctly.

---

### üß† **Rules You MUST Follow**

1. **Do NOT re-layout or recompute child positions on expand**
2. **Do NOT call `fitView()` or auto-layout on collapse/expand**
3. **Child node positions must be relative to the parent**
4. **Child positions must persist across collapse ‚Üí expand**
5. **Only update visibility (`hidden`) on collapse/expand**
6. **Do not refactor unrelated logic or UI**

---

### üß© **Correct Behavior Requirements**

#### When a group is first created:

* Convert child positions from **absolute ‚Üí relative**

```ts
relativeX = child.x - parent.x
relativeY = child.y - parent.y
```

#### Store this relative position:

```ts
node.data.relativePosition = node.position
```

---

#### On collapse:

```ts
hidden = true
```

‚ùå Do NOT change position

---

#### On expand:

```ts
hidden = false
position = data.relativePosition
```

‚ùå Do NOT recalculate

---

#### On child drag:

* Update stored relative position

```ts
onNodeDragStop ‚Üí data.relativePosition = node.position
```

---

### üõ† **What to Change in Code**

* Fix expand/collapse handlers so they **only toggle `hidden`**
* Ensure child nodes:

  * Have `parentNode`
  * Have `extent: "parent"`
  * Never get their `position` reset on expand
* Remove any code that:

  * Re-centers children
  * Uses bounding-box math during expand
  * Re-runs layout on expand

---

### ‚úÖ **Expected Result**

* Moving a group moves all children correctly
* Collapsing hides children
* Expanding restores children **exactly where they were**
* No child node jumps to the center/origin
* No visual jitter or reflow

---

### ‚ùó **Important**

If you see logic that recalculates positions on expand ‚Äî **remove it**.
The correct fix is **state preservation**, not layout math.

---

### üß† **Technology Stack**

* React
* React Flow
* Controlled nodes state (`useNodesState` or reducer)

---

### üß™ **Deliverable**

* A minimal fix
* Clean diff
* No behavior changes outside grouping

---

If you want, next I can:

* Write a **Cursor-style internal guideline** to prevent this forever
* Create a **unit test strategy** for expand/collapse
* Provide a **TypeScript helper** for safe grouping logic

Just tell me.
